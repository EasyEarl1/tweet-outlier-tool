<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tweet Outlier Tool - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            color: #667eea;
            font-size: 2.5em;
            font-weight: bold;
        }
        
        .filters {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-group label {
            color: #666;
            font-size: 0.9em;
            font-weight: 500;
        }
        
        .filter-group input,
        .filter-group select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 10px 25px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 500;
        }
        
        .btn:hover {
            background: #5568d3;
        }
        
        .outliers-table {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #f8f9fa;
        }
        
        th {
            padding: 15px;
            text-align: left;
            color: #666;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .multiplier {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }
        
        .multiplier-negative {
            font-weight: bold;
            color: #e74c3c;
            font-size: 1.1em;
        }
        
        .account-badge {
            display: inline-block;
            padding: 5px 12px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .tweet-text {
            max-width: 400px;
            line-height: 1.5;
            color: #333;
        }
        
        .metrics {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
        }
        
        .metric {
            color: #666;
        }
        
        .metric strong {
            color: #333;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .tweet-link {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9em;
        }
        
        .tweet-link:hover {
            text-decoration: underline;
        }
        
        .accounts-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .accounts-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .add-accounts-form {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .add-accounts-form textarea {
            flex: 1;
            min-width: 300px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }
        
        .add-accounts-form textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .accounts-list {
            margin-top: 20px;
        }
        
        .account-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .account-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .account-info strong {
            color: #667eea;
        }
        
        .account-meta {
            font-size: 0.9em;
            color: #666;
        }
        
        .btn-danger {
            background: #e74c3c;
            padding: 8px 15px;
            font-size: 0.9em;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .message {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üê¶ Tweet Outlier Dashboard</h1>
            <p>Discover tweets that significantly outperformed the average</p>
        </div>
        
        <div class="stats-grid" id="stats">
            <div class="stat-card">
                <h3>Total Accounts</h3>
                <div class="value" id="stat-accounts">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Tweets</h3>
                <div class="value" id="stat-tweets">-</div>
            </div>
            <div class="stat-card">
                <h3>Outliers Found</h3>
                <div class="value" id="stat-outliers">-</div>
            </div>
            <div class="stat-card">
                <h3>Showing</h3>
                <div class="value" id="stat-showing">-</div>
            </div>
        </div>
        
        <div class="accounts-section">
            <h2>üìã Account Management</h2>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('add', this)">Add Accounts</button>
                <button class="tab" onclick="switchTab('settings', this)">Settings</button>
                <button class="tab" onclick="switchTab('manage', this)">Manage Accounts</button>
            </div>
            
            <div id="add-tab" class="tab-content active">
                <div id="add-message" class="message"></div>
                <div class="add-accounts-form">
                    <textarea id="accounts-input" placeholder="Enter usernames, one per line (with or without @)&#10;Example:&#10;elonmusk&#10;@jack&#10;naval&#10;paulg"></textarea>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="btn" onclick="addAccounts()">Add Accounts</button>
                        <button class="btn" onclick="addAccountsAndFetch()" style="background: #28a745;">Add & Fetch Tweets</button>
                        <button class="btn" onclick="clearAccountsInput()" style="background: #6c757d;">Clear</button>
                    </div>
                </div>
                <p style="color: #666; font-size: 0.9em; margin-top: 10px;">
                    üí° Tip: You can paste multiple usernames at once, one per line. Lines starting with # are ignored.<br>
                    <strong>"Add & Fetch Tweets"</strong> will add accounts and immediately start fetching their tweets (may take a while).
                </p>
            </div>
            
            <div id="manage-tab" class="tab-content">
                <div id="manage-message" class="message"></div>
                <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <button class="btn" onclick="fetchAllAccounts()">üîÑ Fetch Tweets for All Accounts</button>
                    <button class="btn" onclick="fetchNewTweetsOnly()" style="background: #28a745;">‚ö° Quick Fetch (Last 7 Days)</button>
                    <button class="btn" onclick="analyzeTweets()" style="background: #17a2b8;">üìä Analyze All Accounts</button>
                    <select id="fetch-months" style="padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="1">Last 1 month</option>
                        <option value="2">Last 2 months</option>
                        <option value="3" selected>Last 3 months</option>
                        <option value="4">Last 4 months</option>
                        <option value="5">Last 5 months</option>
                        <option value="6">Last 6 months</option>
                    </select>
                    <select id="min-days" style="padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="0">Fetch even if recent</option>
                        <option value="1" selected>Skip if fetched < 1 day</option>
                        <option value="3">Skip if fetched < 3 days</option>
                        <option value="7">Skip if fetched < 7 days</option>
                    </select>
                </div>
                <div id="accounts-list" class="accounts-list">
                    <div class="loading">Loading accounts...</div>
                </div>
            </div>
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <label>Time Period</label>
                <select id="time-filter" style="padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    <option value="">All Time</option>
                    <option value="7">Last 7 days</option>
                    <option value="14">Last 14 days</option>
                    <option value="30">Last 30 days</option>
                    <option value="60">Last 60 days</option>
                    <option value="90">Last 90 days</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Sort By</label>
                <select id="sort-by" style="padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    <option value="multiplier">Multiplier (Best First)</option>
                    <option value="date">Date (Newest First)</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Min Multiplier</label>
                <input type="number" id="min-multiplier" value="2.0" step="0.1">
                <small style="color: #666; font-size: 0.85em;">Use negative for underperformers</small>
            </div>
            <div class="filter-group">
                <label>Max Multiplier</label>
                <input type="number" id="max-multiplier" value="" step="0.1" placeholder="No limit">
            </div>
            <div class="filter-group">
                <label>Account</label>
                <select id="account-filter">
                    <option value="">All Accounts</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Limit</label>
                <input type="number" id="limit" value="100" min="1" max="500">
            </div>
            <div class="filter-group">
                <label style="margin-bottom: 5px;">Show</label>
                <select id="show-mode" style="padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    <option value="outliers">Outliers Only (‚â•2.0x)</option>
                    <option value="all">All Tweets</option>
                    <option value="positive">Positive Outliers (‚â•1.0x)</option>
                    <option value="negative">Negative Outliers (<1.0x)</option>
                </select>
            </div>
            <button class="btn" onclick="loadOutliers()">Apply Filters</button>
            <button class="btn" onclick="loadNewTweets()" style="background: #28a745;">üîç Quick Scan New Tweets</button>
        </div>
        
        <div class="outliers-table">
            <div id="loading" class="loading">Loading outliers...</div>
            <div id="empty" class="empty" style="display: none;">No outliers found matching your criteria.</div>
            <table id="outliers-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Account</th>
                        <th>Multiplier</th>
                        <th>Tweet</th>
                        <th>Engagement</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="outliers-tbody">
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        let accounts = [];
        
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                document.getElementById('stat-accounts').textContent = data.total_accounts;
                document.getElementById('stat-tweets').textContent = data.total_tweets.toLocaleString();
                document.getElementById('stat-outliers').textContent = data.total_outliers;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        async function loadApiKeyStatus() {
            try {
                const response = await fetch('/api/settings/api-key');
                const data = await response.json();
                const statusDiv = document.getElementById('api-key-status');
                const instructionsDiv = document.getElementById('api-key-instructions');
                
                if (data.api_key_set) {
                    statusDiv.innerHTML = '<p style="color: #28a745; font-weight: bold;">‚úì API Key is configured</p>';
                    instructionsDiv.style.display = 'none';
                } else {
                    statusDiv.innerHTML = '<p style="color: #e74c3c; font-weight: bold;">‚ö† API Key not configured</p>';
                    instructionsDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading API key status:', error);
                document.getElementById('api-key-status').innerHTML = '<p style="color: #e74c3c;">Error checking API key status</p>';
            }
        }
        
        async function loadAccounts() {
            try {
                const response = await fetch('/api/accounts');
                const data = await response.json();
                accounts = data.accounts;
                
                const select = document.getElementById('account-filter');
                select.innerHTML = '<option value="">All Accounts</option>';
                accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.username;
                    option.textContent = `@${account.username} (${account.outlier_count} outliers)`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        }
        
        async function loadOutliers() {
            const loading = document.getElementById('loading');
            const table = document.getElementById('outliers-table');
            const empty = document.getElementById('empty');
            const tbody = document.getElementById('outliers-tbody');
            
            loading.style.display = 'block';
            table.style.display = 'none';
            empty.style.display = 'none';
            
            try {
                const minMultiplier = document.getElementById('min-multiplier').value;
                const maxMultiplier = document.getElementById('max-multiplier').value;
                const accountFilter = document.getElementById('account-filter').value;
                const limit = document.getElementById('limit').value;
                const showMode = document.getElementById('show-mode').value;
                const timeFilter = document.getElementById('time-filter').value;
                const sortBy = document.getElementById('sort-by').value;
                
                const params = new URLSearchParams({
                    limit: limit,
                    sort_by: sortBy
                });
                
                // Add time filter if specified
                if (timeFilter) {
                    params.append('days_back', timeFilter);
                }
                
                // Handle different show modes
                if (showMode === 'all') {
                    params.append('show_all', 'true');
                    if (minMultiplier) params.append('min_multiplier', minMultiplier);
                    if (maxMultiplier) params.append('max_multiplier', maxMultiplier);
                } else if (showMode === 'positive') {
                    params.append('show_all', 'true');
                    params.append('min_multiplier', '1.0');
                    if (maxMultiplier) params.append('max_multiplier', maxMultiplier);
                } else if (showMode === 'negative') {
                    params.append('show_all', 'true');
                    params.append('max_multiplier', '0.99');
                    if (minMultiplier) params.append('min_multiplier', minMultiplier);
                } else {
                    // Outliers only (default)
                    params.append('min_multiplier', minMultiplier || '2.0');
                    if (maxMultiplier) params.append('max_multiplier', maxMultiplier);
                }
                
                if (accountFilter) {
                    params.append('account', accountFilter);
                }
                
                const response = await fetch(`/api/outliers?${params}`);
                const data = await response.json();
                
                loading.style.display = 'none';
                
                if (data.outliers.length === 0) {
                    empty.style.display = 'block';
                } else {
                    table.style.display = 'table';
                    tbody.innerHTML = '';
                    
                    data.outliers.forEach(outlier => {
                        const row = document.createElement('tr');
                        const date = new Date(outlier.created_at);
                        const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        const multiplierClass = outlier.multiplier >= 1.0 ? 'multiplier' : 'multiplier-negative';
                        const multiplierColor = outlier.multiplier >= 1.0 ? '#667eea' : '#e74c3c';
                        
                        row.innerHTML = `
                            <td>
                                <span class="account-badge">@${outlier.account}</span>
                                <div style="font-size: 0.85em; color: #999; margin-top: 5px;">${outlier.account_display}</div>
                            </td>
                            <td>
                                <span class="multiplier" style="color: ${multiplierColor};">${outlier.multiplier.toFixed(2)}x</span>
                            </td>
                            <td>
                                <div class="tweet-text">${escapeHtml(outlier.text.substring(0, 200))}${outlier.text.length > 200 ? '...' : ''}</div>
                                <a href="https://twitter.com/${outlier.account}/status/${outlier.tweet_id}" target="_blank" class="tweet-link">View on Twitter ‚Üí</a>
                            </td>
                            <td>
                                <div class="metrics">
                                    <div class="metric"><strong>‚ù§Ô∏è</strong> ${outlier.likes.toLocaleString()}</div>
                                    <div class="metric"><strong>üîÑ</strong> ${outlier.retweets.toLocaleString()}</div>
                                    <div class="metric"><strong>üí¨</strong> ${outlier.replies.toLocaleString()}</div>
                                    <div class="metric"><strong>üëÅÔ∏è</strong> ${outlier.views.toLocaleString()}</div>
                                </div>
                            </td>
                            <td style="color: #666; font-size: 0.9em;">${dateStr}</td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    document.getElementById('stat-showing').textContent = data.count;
                }
            } catch (error) {
                console.error('Error loading outliers:', error);
                loading.style.display = 'none';
                empty.style.display = 'block';
                empty.textContent = 'Error loading outliers. Please try again.';
            }
        }
        
        async function loadNewTweets() {
            const loading = document.getElementById('loading');
            const table = document.getElementById('outliers-table');
            const empty = document.getElementById('empty');
            const tbody = document.getElementById('outliers-tbody');
            
            loading.style.display = 'block';
            table.style.display = 'none';
            empty.style.display = 'none';
            
            try {
                const accountFilter = document.getElementById('account-filter').value;
                const limit = document.getElementById('limit').value;
                const timeFilter = document.getElementById('time-filter').value || '7'; // Default to 7 days for quick scan
                
                const params = new URLSearchParams({
                    limit: limit,
                    days_back: timeFilter
                });
                
                if (accountFilter) {
                    params.append('account', accountFilter);
                }
                
                const response = await fetch(`/api/new-tweets?${params}`);
                const data = await response.json();
                
                loading.style.display = 'none';
                
                if (data.tweets.length === 0) {
                    empty.style.display = 'block';
                    empty.textContent = 'No new tweets found in the selected time period.';
                } else {
                    table.style.display = 'table';
                    tbody.innerHTML = '';
                    
                    data.tweets.forEach(tweet => {
                        const row = document.createElement('tr');
                        const date = new Date(tweet.created_at);
                        const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        const multiplierClass = tweet.multiplier >= 1.0 ? 'multiplier' : 'multiplier-negative';
                        const multiplierColor = tweet.multiplier >= 1.0 ? '#667eea' : '#e74c3c';
                        
                        row.innerHTML = `
                            <td>
                                <span class="account-badge">@${tweet.account}</span>
                                <div style="font-size: 0.85em; color: #999; margin-top: 5px;">${tweet.account_display}</div>
                            </td>
                            <td>
                                <span class="multiplier" style="color: ${multiplierColor};">${tweet.multiplier.toFixed(2)}x</span>
                            </td>
                            <td>
                                <div class="tweet-text">${escapeHtml(tweet.text.substring(0, 200))}${tweet.text.length > 200 ? '...' : ''}</div>
                                <a href="https://twitter.com/${tweet.account}/status/${tweet.tweet_id}" target="_blank" class="tweet-link">View on Twitter ‚Üí</a>
                            </td>
                            <td>
                                <div class="metrics">
                                    <div class="metric"><strong>‚ù§Ô∏è</strong> ${tweet.likes.toLocaleString()}</div>
                                    <div class="metric"><strong>üîÑ</strong> ${tweet.retweets.toLocaleString()}</div>
                                    <div class="metric"><strong>üí¨</strong> ${tweet.replies.toLocaleString()}</div>
                                    <div class="metric"><strong>üëÅÔ∏è</strong> ${tweet.views.toLocaleString()}</div>
                                </div>
                            </td>
                            <td style="color: #666; font-size: 0.9em;">${dateStr}</td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    document.getElementById('stat-showing').textContent = data.count;
                }
            } catch (error) {
                console.error('Error loading new tweets:', error);
                loading.style.display = 'none';
                empty.style.display = 'block';
                empty.textContent = 'Error loading new tweets. Please try again.';
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function switchTab(tabName, button) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            button.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'manage') {
                loadAccountsList();
            }
        }
        
        async function addAccounts(fetchAfter = false) {
            const input = document.getElementById('accounts-input');
            const accountsText = input.value.trim();
            const messageDiv = document.getElementById('add-message');
            
            if (!accountsText) {
                showMessage('error', 'Please enter at least one username');
                return;
            }
            
            messageDiv.style.display = 'none';
            
            try {
                const response = await fetch('/api/accounts/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        accounts: accountsText
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('success', data.message);
                    input.value = '';
                    // Reload stats and accounts
                    loadStats();
                    loadAccounts();
                    loadOutliers();
                    
                    // Fetch tweets if requested
                    if (fetchAfter) {
                        showMessage('success', 'Accounts added. Starting to fetch tweets...');
                        // Note: fetchAllAccounts will auto-analyze
                        await fetchAllAccounts();
                    }
                } else {
                    showMessage('error', data.error || 'Failed to add accounts');
                }
            } catch (error) {
                showMessage('error', 'Error adding accounts: ' + error.message);
            }
        }
        
        async function addAccountsAndFetch() {
            await addAccounts(true);
        }
        
        async function fetchAllAccounts() {
            const months = document.getElementById('fetch-months').value;
            const minDays = document.getElementById('min-days').value;
            const messageDiv = document.getElementById('manage-message');
            
            showManageMessage('success', 'Starting to fetch tweets... This may take a while.');
            
            try {
                const response = await fetch('/api/fetch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        months: parseInt(months),
                        min_days: parseInt(minDays)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showManageMessage('success', data.message + ' Now analyzing tweets...');
                    // Automatically analyze after fetching
                    await analyzeTweets();
                } else {
                    showManageMessage('error', data.error || 'Failed to fetch tweets');
                }
            } catch (error) {
                showManageMessage('error', 'Error fetching tweets: ' + error.message);
            }
        }
        
        async function fetchNewTweetsOnly() {
            const minDays = document.getElementById('min-days').value;
            const messageDiv = document.getElementById('manage-message');
            
            showManageMessage('success', 'Quick fetching new tweets from last 7 days...');
            
            try {
                const response = await fetch('/api/fetch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        days: 7,  // Only fetch last 7 days
                        min_days: parseInt(minDays)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showManageMessage('success', data.message + ' Now analyzing tweets...');
                    // Automatically analyze after fetching
                    await analyzeTweets();
                } else {
                    showManageMessage('error', data.error || 'Failed to fetch tweets');
                }
            } catch (error) {
                showManageMessage('error', 'Error fetching tweets: ' + error.message);
            }
        }
        
        async function fetchAccount(username) {
            const months = document.getElementById('fetch-months').value;
            const minDays = document.getElementById('min-days').value;
            const messageDiv = document.getElementById('manage-message');
            
            showManageMessage('success', `Fetching tweets for @${username}...`);
            
            try {
                const response = await fetch('/api/fetch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        months: parseInt(months),
                        account: username,
                        min_days: parseInt(minDays)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showManageMessage('success', data.message + ' Now analyzing...');
                    // Automatically analyze after fetching
                    await analyzeTweets(username);
                } else {
                    showManageMessage('error', data.error || 'Failed to fetch tweets');
                }
            } catch (error) {
                showManageMessage('error', 'Error fetching tweets: ' + error.message);
            }
        }
        
        async function analyzeTweets(accountFilter = null) {
            const months = document.getElementById('fetch-months').value;
            const threshold = document.getElementById('min-multiplier').value || 2.0;
            const messageDiv = accountFilter ? document.getElementById('manage-message') : document.getElementById('manage-message');
            
            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        months: parseInt(months),
                        threshold: parseFloat(threshold),
                        account: accountFilter
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showManageMessage('success', data.message);
                    // Reload everything
                    loadStats();
                    loadAccounts();
                    loadOutliers();
                    loadAccountsList();
                } else {
                    showManageMessage('error', data.error || 'Failed to analyze tweets');
                }
            } catch (error) {
                showManageMessage('error', 'Error analyzing tweets: ' + error.message);
            }
        }
        
        function showMessage(type, text) {
            const messageDiv = document.getElementById('add-message');
            messageDiv.className = 'message ' + type;
            messageDiv.textContent = text;
            messageDiv.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        function clearAccountsInput() {
            document.getElementById('accounts-input').value = '';
            document.getElementById('add-message').style.display = 'none';
        }
        
        async function loadAccountsList() {
            const listDiv = document.getElementById('accounts-list');
            listDiv.innerHTML = '<div class="loading">Loading accounts...</div>';
            
            try {
                const response = await fetch('/api/accounts');
                const data = await response.json();
                
                if (data.accounts.length === 0) {
                    listDiv.innerHTML = '<div class="empty">No accounts in database. Add some accounts to get started!</div>';
                    return;
                }
                
                listDiv.innerHTML = '';
                data.accounts.forEach(account => {
                    const item = document.createElement('div');
                    item.className = 'account-item';
                    item.innerHTML = `
                        <div class="account-info">
                            <div>
                                <strong>@${account.username}</strong>
                                ${account.display_name && account.display_name !== account.username ? `<div class="account-meta">${account.display_name}</div>` : ''}
                            </div>
                            <div class="account-meta" style="margin-left: 20px;">
                                ${account.tweet_count} tweets ‚Ä¢ ${account.outlier_count} outliers
                                ${account.follower_count > 0 ? ` ‚Ä¢ ${account.follower_count.toLocaleString()} followers` : ''}
                                ${account.last_fetched_at ? ` ‚Ä¢ last fetched ${new Date(account.last_fetched_at).toLocaleString()}` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="fetchAccount('${account.username}')" style="background: #28a745; font-size: 0.9em; padding: 8px 15px;">Fetch</button>
                            <button class="btn btn-danger" onclick="deleteAccount('${account.username}')">Delete</button>
                        </div>
                    `;
                    listDiv.appendChild(item);
                });
            } catch (error) {
                listDiv.innerHTML = '<div class="empty">Error loading accounts: ' + error.message + '</div>';
            }
        }
        
        async function deleteAccount(username) {
            if (!confirm(`Are you sure you want to delete @${username}? This will also delete all associated tweets.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/accounts/${username}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showManageMessage('success', data.message);
                    loadAccountsList();
                    loadStats();
                    loadAccounts();
                    loadOutliers();
                } else {
                    showManageMessage('error', data.error || 'Failed to delete account');
                }
            } catch (error) {
                showManageMessage('error', 'Error deleting account: ' + error.message);
            }
        }
        
        function showManageMessage(type, text) {
            const messageDiv = document.getElementById('manage-message');
            messageDiv.className = 'message ' + type;
            messageDiv.textContent = text;
            messageDiv.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        // Load data on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadAccounts();
            loadOutliers();
        });
    </script>
</body>
</html>

